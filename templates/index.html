<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <title>ì±„íŒ…ë´‡</title>
    <link rel="stylesheet" href="static\css\styles.css">
</head>
<body>
    <div id="sidebar">
        <div class="title">ì¸ê³µì§€ëŠ¥ ì—…ë¬´ë„ìš°ë¯¸ ğŸ’¡</div>
        <div class="menu-item">
            âš™ï¸ ì„¤ì •
            <ul>
                <li class="sub-menu" onclick="openModal('share-modal')">Confluence</li>
                <li class="sub-menu" onclick="openModal('email-modal')">Email</li>
                <li class="sub-menu" onclick="openModal('calendar-modal')">Google Calendar</li>
            </ul>
        </div>
        <div class="menu-item">
            ğŸ“‚ ê¸°ëŠ¥
            <ul>
                <li class="sub-menu" onclick="openModal('file-upload-modal')">ë¬¸ì„œë²ˆì—­</li>
                <li class="sub-menu" onclick="openModal('report-draft-modal')">ë³´ê³ ì„œ ì´ˆì•ˆ ì‘ì„±</li>
                <li class="sub-menu" onclick="openModal('minutes-draft-modal')">íšŒì˜ë¡ ì´ˆì•ˆ ì‘ì„±</li>
                <li class="sub-menu" onclick="openModal('meeting-schedule-modal')">ë¯¸íŒ… ì¼ì • ìƒì„±</li>
            </ul>
        </div>
    </div>
    
    <div id="chat-container">
        <div id="chat-box"></div>
        <div id="input-box">
            <input type="text" id="user-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" onkeydown="handleKeydown(event)">
            <button id="send-button" onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </div>

   <!-- ëª¨ë‹¬ ë‹¤ì´ì–¼ë¡œê·¸ë“¤ -->
   <div id="share-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('share-modal')">&times;</span>
            <h2>Confluence ì •ë³´</h2>
            <label for="access-token">ê°œì¸ìš© ì—‘ì„¸ìŠ¤ í† í°</label><br>
            <input type="text" id="access-token" name="access-token"><br><br>
            <label for="login-account">ë¡œê·¸ì¸ ê³„ì •</label><br>
            <input type="text" id="login-account" name="login-account"><br><br><br><br>
            <button id="save-button" onclick="saveShare()">Save</button>
        </div>
    </div>

    <div id="email-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('email-modal')">&times;</span>
            <h2>Email ì •ë³´</h2>
            <label for="email-id">ì•„ì´ë””</label><br>
            <input type="text" id="email-id" name="email-id"><br><br>
            <label for="email-password">íŒ¨ìŠ¤ì›Œë“œ</label><br>
            <input type="password" id="email-password" name="email-password"><br><br><br><br>
            <button id="save-button" onclick="saveEmail()">Save</button>
        </div>
    </div>
    <div id="calendar-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('calendar-modal')">&times;</span>
            <h2>Google Calendar</h2>
            <label for="google-id">êµ¬ê¸€ ê³„ì • ì•„ì´ë””</label><br>
            <input type="text" id="google-id" name="google-id"><br><br>
            <br><br>
            <button id="save-button" onclick="saveCalendar()">Save</button>
        </div>
    </div>
    <div id="file-upload-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('file-upload-modal')">&times;</span>
            <h2>ë¬¸ì„œ ë²ˆì—­ê¸°</h2>
            <h4>íŒŒì¼ ì—…ë¡œë“œ</h4>
            <input type="file" id="translate-file-upload" name="file-upload" accept=".txt, .pdf, .doc, .docx"><br>
            <h4>ë²ˆì—­í•  ì–¸ì–´</h4>
            <select id="language-select">
                <option value="en">ì˜ì–´</option>
                <option value="ko">í•œêµ­ì–´</option>
                <option value="ja">ì¼ë³¸ì–´</option>
            </select><br><br><br>
            <button id="save-button" onclick="translateUploadFile()">Upload</button>
        </div>
    </div>
    <div id="report-draft-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('report-draft-modal')">&times;</span>
            <h2>ë³´ê³ ì„œ ì´ˆì•ˆ ì‘ì„±</h2>
            <h4>Share í˜ì´ì§€</h4>
            <div class="share-link-input-container">
                <input type="text" id="share-link" name="share-link" placeholder="ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <button id="arrow-button" onclick="checkConfluenceInfo()">â†‘</button>
                <div class="page-titles-container" id="page-titles-container"></div>
            </div>
            <h4>E-mail</h4>
            <div style="display: flex; align-items: center;">
                <button onclick="checkEmailInfo('report-email-select')">ì´ë©”ì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <span style="font-size: smaller; font-weight: normal; color: #888; margin-left: 10px;">ìµœì‹  50ê°œì˜ ë©”ì¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤</h4>
            </div>
            <div id="report-email-list" class="email-list">
                <select id="report-email-select" class="email-select" onchange="selectEmail()">
                    <option value="-1">ì´ë©”ì¼ ì„ íƒ</option>
                </select>
            </div>
            <h4>íŒŒì¼ ì—…ë¡œë“œ</h4>
            <input type="file" id="report-file-upload" name="file-upload" accept=".txt, .pdf, .doc, .docx"><br><br><br>
            <button id="save-button" onclick="draftReport()">Upload</button>
        </div>
    </div>
    <div id="minutes-draft-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('minutes-draft-modal')">&times;</span>
            <h2>íšŒì˜ë¡ ì´ˆì•ˆ ì‘ì„±</h2>
            <h4>Share í˜ì´ì§€</h4>
            <div class="share-link-input-container">
                <input type="text" id="share-link" name="share-link" placeholder="ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <button id="arrow-button" onclick="checkConfluenceInfo()">â†‘</button>
                <div class="page-titles-container" id="page-titles-container"></div>
            </div>
            <h4>E-mail</h4>
            <div style="display: flex; align-items: center;">
                <button onclick="checkEmailInfo('report-email-select')">ì´ë©”ì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <span style="font-size: smaller; font-weight: normal; color: #888; margin-left: 10px;">ìµœì‹  50ê°œì˜ ë©”ì¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤</h4>
            </div>
            <div id="minutes-email-list" class="email-list">
                <select id="minutes-email-select" class="email-select" onchange="selectEmail()">
                    <option value="-1">ì´ë©”ì¼ ì„ íƒ</option>
                </select>
            </div>
            <h4>íŒŒì¼ ì—…ë¡œë“œ</h4>
            <input type="file" id="minutes-file-upload" name="file-upload" accept=".txt, .pdf, .doc, .docx"><br><br><br>
            <button id="save-button" onclick="draftMinutes()">Upload</button>
        </div>
    </div>
    <div id="meeting-schedule-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('meeting-schedule-modal')">&times;</span>
            <h2>ë¯¸íŒ… ì¼ì • ìƒì„±</h2>
            <h4>E-mail</h4>
            <div style="display: flex; align-items: center;">
                <button onclick="checkEmailInfo('meething-email-select')">ì´ë©”ì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <span style="font-size: smaller; font-weight: normal; color: #888; margin-left: 10px;">ìµœì‹  50ê°œì˜ ë©”ì¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤</h4>
            </div>
            <div id="meething-email-list" class="email-list">
                <select id="meething-email-select" class="email-select">
                    <option value="-1">ì´ë©”ì¼ ì„ íƒ</option>
                </select><br>
            </div>
            <h4>ë°˜í™˜</h4>
            <input type="radio" id="option1" name="option" value="option1">
            <label for="option1">êµ¬ê¸€ ìº˜ë¦°ë” ì¼ì • ë“±ë¡</label><br>
            <input type="radio" id="option2" name="option" value="option2">
            <label for="option2">ê°€ëŠ¥í•œ ì¼ì • ë¦¬ìŠ¤íŠ¸ ìƒì„±</label><br><br><br><br>
            <button id="save-button" onclick="createSchedule()">Upload</button>
        </div>
    </div>


    <script>
        var emails = [];
        var share_page = [];
        async function sendMessage() {
            var userInput = document.getElementById('user-input').value;
            console.log(userInput)
            if (userInput.trim() !== '') {
                var chatBox = document.getElementById('chat-box');
                var userMessageContainer = document.createElement('div');
                userMessageContainer.classList.add('message-container', 'user-message-container');
                
                var userMessageBubble = document.createElement('div');
                userMessageBubble.classList.add('message-bubble', 'user-message-bubble');
                userMessageBubble.textContent = userInput;

                userMessageContainer.appendChild(userMessageBubble);
                chatBox.appendChild(userMessageContainer);

                // ëŒ€ê¸° ì¤‘ì¸ ë©”ì‹œì§€ë¥¼ í‘œì‹œ
                var waitingMessageContainer = document.createElement('div');
                waitingMessageContainer.id = 'waiting-message';
                waitingMessageContainer.classList.add('message-container', 'waiting-message-bubble');
                waitingMessageContainer.innerHTML = '<div id="spinner"></div>';
                chatBox.appendChild(waitingMessageContainer);

                // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ìµœí•˜ë‹¨ìœ¼ë¡œ ì¡°ì •
                chatBox.scrollTop = chatBox.scrollHeight;

                document.getElementById('user-input').value = '';

                var formData = new FormData();
                formData.append('text', userInput);

                try {
                    // http post ìš”ì²­
                    const response = await fetch('/send-message/', {
                        method: 'POST',
                        body: formData
                    });
                    if (!response.ok) {
                        handleServerError(response)
                    }

                    const data = await response.json();
                    if('image' in data) {
                        displayImage(data.image, data.message+'\n\n')
                    }
                    else{
                        displayMessage(data.message);
                    } 
                    print(data)
                } catch (error) {
                    console.error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error); 
                }

                chatBox.removeChild(waitingMessageContainer);
            }
        }
        function displayMessage(message) {
            var chatBox = document.getElementById('chat-box');
            var botMessageContainer = document.createElement('div');
            botMessageContainer.classList.add('message-container', 'bot-message-container');

            var botMessageBubble = document.createElement('div');
            botMessageBubble.classList.add('message-bubble', 'bot-message-bubble');
            botMessageBubble.textContent = message;

            botMessageContainer.appendChild(botMessageBubble);
            chatBox.appendChild(botMessageContainer);

            // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ìµœí•˜ë‹¨ìœ¼ë¡œ ì¡°ì •
            chatBox.scrollTop = chatBox.scrollHeight;
            // ëŒ€ê¸° ì¤‘ì¸ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì‚­ì œ
            var waitingMessage = document.getElementById('waiting-message');
            if (waitingMessage) {
                chatBox.removeChild(waitingMessage);
            }
        }
        function displayImage(image, text) {
            var chatBox = document.getElementById('chat-box');
            
            var messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble', 'bot-message-bubble');
            messageBubble.textContent = text;

            var imageContainer = document.createElement('img');
            imageContainer.src = image
            
            messageBubble.appendChild(imageContainer);
            chatBox.appendChild(messageBubble);

            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function handleKeydown(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        // ëª¨ë‹¬ ì—´ê¸°
        function openModal(modalId) {
            var modal = document.getElementById(modalId);
            modal.style.display = "block";
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal(modalId) {
            var modal = document.getElementById(modalId);
            modal.style.display = "none";
        }

        // ì‚¬ìš©ìê°€ ëª¨ë‹¬ ì™¸ë¶€ë¥¼ í´ë¦­í–ˆì„ ë•Œ ëª¨ë‹¬ ë‹«ê¸°
        window.onclick = function(event) {
            var modals = document.getElementsByClassName('modal');
            for (var i = 0; i < modals.length; i++) {
                var modal = modals[i];
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        }
        // ì„¤ì • ì •ë³´ ì €ì¥ ë©”ì†Œë“œ
        function saveShare() {
            var accessToken = document.getElementById('access-token').value;
            var loginAccount = document.getElementById('login-account').value;

            console.log("Access Token:", accessToken);
            console.log("Login Account:", loginAccount);

            // í•„ìš”í•œ ì €ì¥ ë˜ëŠ” ì²˜ë¦¬ ë¡œì§ì„ ì¶”ê°€í•˜ì„¸ìš”.

            // ëª¨ë‹¬ ë‹«ê¸°
            closeModal('share-modal');
        }
        function saveEmail() {
            var id = document.getElementById('email-id').value;
            var pw = document.getElementById('email-password').value;

            console.log("Email Id:", id);
            console.log("Email Password:", pw);
            
            // ëª¨ë‹¬ ë‹«ê¸°
            closeModal('email-modal');
        }
        function saveCalendar() {

            // ëª¨ë‹¬ ë‹«ê¸°
            closeModal('calendar-modal');
        }
        
        // ê¸°ëŠ¥ í•¨ìˆ˜
        // ì‰ì–´ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadShare(shareLink){
            var accessToken = document.getElementById('access-token').value.trim();
            var loginAccount = document.getElementById('login-account').value.trim();
            var formData = new FormData();
            formData.append('accessToken', accessToken);
            formData.append('loginAccount', loginAccount);
            formData.append('shareLink', shareLink);

            try {
                const response = await fetch('/load-share/', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    handleServerError(response)
                }
                    const pages = await response.json();
                    displayPageTitles(pages)

                } catch (error) {
                console.error('ì‰ì–´ í˜ì´ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
            }
        }
        function checkConfluenceInfo() {
            var accessToken = document.getElementById('access-token').value.trim();
            var loginAccount = document.getElementById('login-account').value.trim();
            if (accessToken == '' || loginAccount == ''){
                alert("ì»¨í”Œë£¨ì–¸ìŠ¤ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
                return;        
            }
            var shareLink = document.getElementById('share-link').value;
            
            loadShare(shareLink);
        }
        function displayPageTitles(pages) {
            share_page = []
            var pageTitlesContainer = document.getElementById('page-titles-container');
            pageTitlesContainer.innerHTML = ''; 
            pages.forEach((page, index) => {
                var pageTitleBox = document.createElement('div');
                share_page.push(page)
                pageTitleBox.textContent = page.title;
                pageTitleBox.classList.add('page-title-box'); 
                pageTitlesContainer.appendChild(pageTitleBox);
            });
        }

        // ë¬¸ì„œ ë²ˆì—­
        async function translateUploadFile() {
            var fileInput = document.getElementById('translate-file-upload');
            var file = fileInput.files[0];
            var language = document.getElementById('language-select').value;
            
            // ëª¨ë‹¬ ë‹«ê¸°
            closeModal('file-upload-modal');
            console.log(file);

            if (file) {
                var chatBox = document.getElementById('chat-box');
                var messageContainer = document.createElement('div');
                messageContainer.classList.add('message-container', 'bot-message-container');
                
                var messageBubble = document.createElement('div');
                messageBubble.classList.add('message-bubble', 'bot-message-bubble');
                messageBubble.textContent = "ë¬¸ì„œë¥¼ ë²ˆì—­í•˜ê³  ìˆìŠµë‹ˆë‹¤";

                messageContainer.appendChild(messageBubble);
                chatBox.appendChild(messageContainer);

                // ëŒ€ê¸° ì¤‘ì¸ ë©”ì‹œì§€ë¥¼ í‘œì‹œ
                var waitingMessageContainer = document.createElement('div');
                waitingMessageContainer.id = 'waiting-message';
                waitingMessageContainer.classList.add('message-container', 'waiting-message-bubble');
                waitingMessageContainer.innerHTML = '<div id="spinner"></div>';
                chatBox.appendChild(waitingMessageContainer);

                // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ìµœí•˜ë‹¨ìœ¼ë¡œ ì¡°ì •
                chatBox.scrollTop = chatBox.scrollHeight;

                var formData = new FormData();
                formData.append('file', file);
                formData.append('language', language);
                
                try {
                    // http post ìš”ì²­
                    const response = await fetch('/translate-document/', {
                        method: 'POST',
                        body: formData
                    });
                    if (!response.ok) {
                        handleServerError(response)
                    }else{
                        const filename = response.headers.get('Content-Disposition').split('filename=')[1];
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        console.log(url);
                        a.click();
                        window.URL.revokeObjectURL(url);
                    }
                } catch (error) {
                    console.error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error); 
                }

                // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ìµœí•˜ë‹¨ìœ¼ë¡œ ì¡°ì •
                chatBox.scrollTop = chatBox.scrollHeight;
                // ëŒ€ê¸° ì¤‘ì¸ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì‚­ì œ
                var waitingMessage = document.getElementById('waiting-message');
                if (waitingMessage) {
                    chatBox.removeChild(waitingMessage);
                }
            }
        }
        function displayMessageWithDownloadLink(message, downloadUrl) {
            var chatBox = document.getElementById('chat-box');
            var botMessageContainer = document.createElement('div');
            botMessageContainer.classList.add('message-container', 'bot-message-container');

            var botMessageBubble = document.createElement('div');
            botMessageBubble.classList.add('message-bubble', 'bot-message-bubble');
            botMessageBubble.textContent = message;

            botMessageContainer.appendChild(botMessageBubble);
            chatBox.appendChild(botMessageContainer);

            // ë²ˆì—­ëœ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
            var downloadContainer = document.createElement('div');
            downloadContainer.classList.add('message-container', 'bot-message-container');

            var downloadBubble = document.createElement('div');
            downloadBubble.classList.add('message-bubble', 'bot-message-bubble');

            // ë²ˆì—­ëœ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
            var downloadLink = document.createElement('a');
            downloadLink.textContent = "translated_file.txt";
            downloadLink.href = downloadUrl;
            downloadLink.download = "translated_file.txt";

            downloadBubble.appendChild(downloadLink);
            downloadContainer.appendChild(downloadBubble);
            chatBox.appendChild(downloadContainer);

        }
        
        // ì„œë²„ ì˜¤ë¥˜ ì²˜ë¦¬
        async function handleServerError(response){
            if (!response.ok) {
                const errorMessage = await response.text();
                console.error('ì„œë²„ ì˜¤ë¥˜:', errorMessage);
                
                //ì˜¤ë¥˜ë©”ì„¸ì§€ ìƒì„±
                var chatBox = document.getElementById('chat-box');
                var botMessageContainer = document.createElement('div');
                botMessageContainer.classList.add('message-container', 'bot-message-container');

                var botMessageBubble = document.createElement('div');
                botMessageBubble.classList.add('message-bubble', 'bot-message-bubble');
                botMessageBubble.textContent = "ì‘ë‹µ ìƒì„±ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.";

                botMessageContainer.appendChild(botMessageBubble);
                chatBox.appendChild(botMessageContainer);

                // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ìµœí•˜ë‹¨ìœ¼ë¡œ ì¡°ì •
                chatBox.scrollTop = chatBox.scrollHeight;
                
                return Promise.resolve(null);
            }
        }
         
        // ë³´ê³ ì„œ ì´ˆì•ˆ ì‘ì„±
        async function draftReport(){
            var formData = new FormData();
            
            // ì´ë©”ì¼ 
            var emailSelect = document.getElementById('report-email-select');
            var selectIndex = emailSelect.value;
            if(selectIndex != "-1"){
                const selectedEmail = emails[parseInt(selectIndex)];
                formData.append('emailIndex', 49 - parseInt(selectIndex));
                formData.append('emailTitle', emails[selectIndex].subject)
            }
            // íŒŒì¼
            var fileInput = document.getElementById('report-file-upload');
            var file = fileInput.files[0];
            if(file){
                formData.append('file', file);
            }

            // ì»¨í”Œë£¨ì–¸ìŠ¤
            if(share_page.length){
                formData.append('share', share_page.length);
            }

            if(share_page.length == 0 && selectIndex == "-1" && file == undefined){
                alert("í•˜ë‚˜ ì´ìƒì˜ ì…ë ¥ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.")
                return
            }
            var shareLink = document.getElementById('share-link').value;
            var accessToken = document.getElementById('access-token').value.trim();
            formData.append('shareLink', shareLink)
            formData.append('accessToken', accessToken)

            closeModal('report-draft-modal')

            var chatBox = document.getElementById('chat-box');
            var messageContainer = document.createElement('div');
            messageContainer.classList.add('message-container', 'bot-message-container');
            
            var messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble', 'bot-message-bubble');
            messageBubble.textContent = "ë³´ê³ ì„œ ì´ˆì•ˆì„ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤";

            messageContainer.appendChild(messageBubble);
            chatBox.appendChild(messageContainer);

            // ëŒ€ê¸° ì¤‘ì¸ ë©”ì‹œì§€ë¥¼ í‘œì‹œ
            var waitingMessageContainer = document.createElement('div');
            waitingMessageContainer.id = 'waiting-message';
            waitingMessageContainer.classList.add('message-container', 'waiting-message-bubble');
            waitingMessageContainer.innerHTML = '<div id="spinner"></div>';
            chatBox.appendChild(waitingMessageContainer);

            // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ìµœí•˜ë‹¨ìœ¼ë¡œ ì¡°ì •
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                // http post ìš”ì²­
                const response = await fetch('/draft-report/', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    handleServerError(response)
                }
                const data = await response.json();
                title = data.title
                link = data.link

                var chatBox = document.getElementById('chat-box');
                var titleContainer = document.createElement('div');
                titleContainer.classList.add('message-container', 'bot-message-container');
                
                var titleBubble = document.createElement('div');
                titleBubble.classList.add('message-bubble', 'bot-message-bubble');
                titleBubble.textContent = "title: "+title;

                var linkContainer = document.createElement('div');
                linkContainer.classList.add('message-container', 'bot-message-container');

                var linkBubble = document.createElement('a');
                linkBubble.classList.add('message-bubble', 'bot-message-bubble');
                linkBubble.textContent = link;
                linkBubble.href = link;

                titleContainer.appendChild(titleBubble);
                linkContainer.appendChild(linkBubble);
                chatBox.appendChild(titleContainer);
                chatBox.appendChild(linkContainer);

            } catch (error) {
                console.error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error); 
            }

            // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ìµœí•˜ë‹¨ìœ¼ë¡œ ì¡°ì •
            chatBox.scrollTop = chatBox.scrollHeight;
            // ëŒ€ê¸° ì¤‘ì¸ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì‚­ì œ
            var waitingMessage = document.getElementById('waiting-message');
            if (waitingMessage) {
                chatBox.removeChild(waitingMessage);
            }
        }

        // ì´ë©”ì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadEmails(listId) {
            var emailId = document.getElementById('email-id').value.trim();
            var emailPassword = document.getElementById('email-password').value.trim();
            var formData = new FormData();
            formData.append('id', emailId);
            formData.append('password', emailPassword);

            try {
                const response = await fetch('/load-emails/', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    handleServerError(response)
                }
                emails = await response.json();

                const emailSelect = document.getElementById(listId);
                // ì´ë©”ì¼ ë¦¬ìŠ¤íŠ¸ë¥¼ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ì— ì¶”ê°€
                emails.forEach((email, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${email.subject} - from <${email.from[0]}> - date:  ${email.date}`;
                    emailSelect.appendChild(option);
                });
            } catch (error) {
                console.error('ì´ë©”ì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
            }
        }
        function checkEmailInfo(listId){
            var emailId = document.getElementById('email-id').value.trim();
            var emailPassword = document.getElementById('email-password').value.trim();
            if(emailId == '' || emailPassword == ''){
                alert("ì´ë©”ì¼ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
                return
            }   
            loadEmails(listId);
        }
        
        async function createSchedule(){
            var emailSelect = document.getElementById('meething-email-select');
            var selectIndex = emailSelect.value;
            var option1Checked = document.getElementById('option1').checked;
            var option2Checked = document.getElementById('option2').checked;
            
            if(selectIndex == "-1"){
                alert("ì´ë©”ì¼ì„ ì„ íƒí•˜ì„¸ìš”.")
                return
            }
            if(!option1Checked && !option2Checked){
                alert("ë°˜í™˜ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”.")
                return
            }
            const selectedEmail = emails[parseInt(selectIndex)];
            var formData = new FormData();
            formData.append('index', 49 - parseInt(selectIndex));
            formData.append('subject', selectedEmail.subject);
            formData.append('date', selectedEmail.date);
            formData.append('from', selectedEmail.from[0]);

            closeModal('meeting-schedule-modal')

            // ë©”ì„¸ì§€ ìƒì„±
            var chatBox = document.getElementById('chat-box');
            var messageContainer = document.createElement('div');
            messageContainer.classList.add('message-container', 'bot-message-container');
            
            var messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble', 'bot-message-bubble');
            messageBubble.textContent = "ë¯¸íŒ… ì¼ì •ì„ êµ¬ê¸€ ìº˜ë¦°ë”ì— ë“±ë¡í•©ë‹ˆë‹¤.";

            messageContainer.appendChild(messageBubble);
            chatBox.appendChild(messageContainer);

            // ëŒ€ê¸° ì¤‘ì¸ ë©”ì‹œì§€ë¥¼ í‘œì‹œ
            var waitingMessageContainer = document.createElement('div');
            waitingMessageContainer.id = 'waiting-message';
            waitingMessageContainer.classList.add('message-container', 'waiting-message-bubble');
            waitingMessageContainer.innerHTML = '<div id="spinner"></div>';
            chatBox.appendChild(waitingMessageContainer);

            // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ìµœí•˜ë‹¨ìœ¼ë¡œ ì¡°ì •
            chatBox.scrollTop = chatBox.scrollHeight;

            // êµ¬ê¸€ ìº˜ë¦°ë” ì¼ì • ë“±ë¡
            if(option1Checked){
                try {
                    const response = await fetch('/post-calender/', {
                        method: 'POST',
                        body: formData
                    });
                    if (!response.ok) {
                        handleServerError(response)
                    }
                    const data = await response.json();
                    var message = "ì¼ì • ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n" +
                    "ì¼ì •ìš”ì•½: " + data.summary + "\n" +
                    "ì¥ì†Œ: " + data.location + "\n" +
                    "ë‚ ì§œ: " + data.dateTime;


                    // ì‘ë‹µ ë©”ì„¸ì§€
                    var chatBox = document.getElementById('chat-box');
                    var messageContainer = document.createElement('div');
                    messageContainer.classList.add('message-container', 'bot-message-container');
            
                    var responseMessageBubble = document.createElement('div');
                    responseMessageBubble.classList.add('message-bubble', 'bot-message-bubble');
                    responseMessageBubble.textContent = message;

                    messageContainer.appendChild(responseMessageBubble);
                    chatBox.appendChild(messageContainer);

                } catch (error) {
                    console.error('ìº˜ë¦°ë” ì¼ì • ìƒì„± ì˜¤ë¥˜', error);
                }   
            }
            chatBox.removeChild(waitingMessageContainer);
        }
    
    </script>
</body>
</html>
